name: Todo App - Claudeä¸¦åˆ—é–‹ç™º

on:
  workflow_dispatch:
    inputs:
      development_target:
        description: "é–‹ç™ºå¯¾è±¡"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - backend
          - frontend
      task_description:
        description: "é–‹ç™ºã‚¿ã‚¹ã‚¯ã®èª¬æ˜"
        required: true
        default: "TodoåŸºæœ¬æ©Ÿèƒ½ã®å®Ÿè£…"

jobs:
  backend-development:
    if: ${{ github.event.inputs.development_target == 'backend' || github.event.inputs.development_target == 'both' }}
    strategy:
      matrix:
        agent_id: [backend-agent-a, backend-agent-b]
    runs-on: ubuntu-latest
    name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º (${{ matrix.agent_id }})
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Claude CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: ğŸ¤– Kamuiå¼ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– Kamuiå¼ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹• (${{ matrix.agent_id }})"

          # APIä»•æ§˜ã‚’èª­ã¿è¾¼ã‚“ã§è²¬å‹™ã‚’æ˜ç¢ºåŒ–
          if [ -f "todo-app/api-spec.md" ]; then
            API_SPEC=$(cat todo-app/api-spec.md)
            echo "ğŸ“‹ APIä»•æ§˜ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            API_SPEC="åŸºæœ¬çš„ãªTodo CRUD APIä»•æ§˜"
          fi

          # Kamuiå¼ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          KAMUI_BACKEND_PROMPT="ã‚ãªãŸã¯è‡ªå¾‹çš„ãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ${{ matrix.agent_id }}ï¼‰ã§ã™ã€‚

          ã€è²¬å‹™ã€‘ä»¥ä¸‹ã®APIä»•æ§˜ã‚’æº€ãŸã™ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
          $API_SPEC

          ã€ã‚¿ã‚¹ã‚¯ã€‘${{ github.event.inputs.task_description }}

          ã€æŠ€è¡“è¦ä»¶ã€‘
          - Node.js + Express.js
          - SQLite ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
          - CRUDæ“ä½œå®Œå…¨å®Ÿè£…
          - é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          - CORSå¯¾å¿œ
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®

          ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‰¹æ€§ã€‘
          backend-agent-a: å …å®Ÿã§ä¿å®ˆæ€§é‡è¦–ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å……å®Ÿ
          backend-agent-b: åŠ¹ç‡çš„ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–ã€æœ€æ–°æŠ€è¡“æ´»ç”¨

          ã€å‡ºåŠ›è¦æ±‚ã€‘
          - å®Œå…¨ãªapp.jsãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡ºåŠ›
          - èª¬æ˜æ–‡ã¯ä¸è¦
          - å³åº§ã«å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰

          å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š"

          echo "ğŸ’­ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ€è€ƒä¸­..."
          claude -p "$KAMUI_BACKEND_PROMPT" > backend_implementation_${{ matrix.agent_id }}.js || {
            echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œå¤±æ•—"
            echo "// ã‚¨ãƒ©ãƒ¼: Claudeå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ" > backend_implementation_${{ matrix.agent_id }}.js
          }

          echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Œäº† (${{ matrix.agent_id }})"

      - name: ç”Ÿæˆã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
        run: |
          echo "=== ç”Ÿæˆã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ (${{ matrix.agent_id }}) ==="
          cat backend_implementation_${{ matrix.agent_id }}.js

      - name: å®Ÿè£…ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã«é…ç½®
        run: |
          mkdir -p todo-app/backend-${{ matrix.agent_id }}/src
          cp backend_implementation_${{ matrix.agent_id }}.js todo-app/backend-${{ matrix.agent_id }}/src/app.js
          cp todo-app/backend/package.json todo-app/backend-${{ matrix.agent_id }}/

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd todo-app/backend-${{ matrix.agent_id }}
          npm install

      - name: æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          cd todo-app/backend-${{ matrix.agent_id }}
          node -c src/app.js > test_result.txt 2>&1 || echo "æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ" >> test_result.txt
          cat test_result.txt

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_id }}-results
          path: |
            todo-app/backend-${{ matrix.agent_id }}/src/app.js
            todo-app/backend-${{ matrix.agent_id }}/test_result.txt

  frontend-development:
    if: ${{ github.event.inputs.development_target == 'frontend' || github.event.inputs.development_target == 'both' }}
    strategy:
      matrix:
        agent_id: [frontend-agent-a, frontend-agent-b]
    runs-on: ubuntu-latest
    name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º (${{ matrix.agent_id }})
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Claude CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: ğŸ¨ Kamuiå¼ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¨ Kamuiå¼ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹• (${{ matrix.agent_id }})"

          # ãƒ†ã‚¹ãƒˆä»•æ§˜ã‚’èª­ã¿è¾¼ã‚“ã§è²¬å‹™ã‚’æ˜ç¢ºåŒ–
          if [ -f "todo-app/frontend/src/App.test.js" ]; then
            TEST_SPEC=$(cat todo-app/frontend/src/App.test.js)
            echo "ğŸ“‹ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆä»•æ§˜ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            TEST_SPEC="åŸºæœ¬çš„ãªReactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ"
          fi

          # Kamuiå¼ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          KAMUI_FRONTEND_PROMPT="ã‚ãªãŸã¯è‡ªå¾‹çš„ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ${{ matrix.agent_id }}ï¼‰ã§ã™ã€‚

          ã€è²¬å‹™ã€‘ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆä»•æ§˜ã‚’æº€ãŸã™Reactã‚¢ãƒ—ãƒªã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
          $TEST_SPEC

          ã€ã‚¿ã‚¹ã‚¯ã€‘${{ github.event.inputs.task_description }}

          ã€æŠ€è¡“è¦ä»¶ã€‘
          - React + JavaScript (é–¢æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)
          - React Hooks (useState, useEffect)
          - Todo CRUDæ©Ÿèƒ½å®Œå…¨å®Ÿè£…
          - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
          - é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£é‡è¦–
          - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è€ƒæ…®

          ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‰¹æ€§ã€‘
          frontend-agent-a: å …å®Ÿã§ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£é‡è¦–ã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å……å®Ÿ
          frontend-agent-b: å‰µé€ çš„ã§ãƒ‡ã‚¶ã‚¤ãƒ³é‡è¦–ã€æœ€æ–°UI/UXæŠ€è¡“æ´»ç”¨

          ã€å‡ºåŠ›è¦æ±‚ã€‘
          - å®Œå…¨ãªApp.jsãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡ºåŠ›
          - èª¬æ˜æ–‡ã¯ä¸è¦
          - å³åº§ã«å®Ÿè¡Œå¯èƒ½ãªReactã‚³ãƒ¼ãƒ‰
          - import/exportæ–‡ã‚’å«ã‚€å®Œå…¨ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

          å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š"

          echo "ğŸ’­ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ€è€ƒä¸­..."
          claude -p "$KAMUI_FRONTEND_PROMPT" > frontend_implementation_${{ matrix.agent_id }}.js || {
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œå¤±æ•—"
            echo "// ã‚¨ãƒ©ãƒ¼: Claudeå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ" > frontend_implementation_${{ matrix.agent_id }}.js
          }

          echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Œäº† (${{ matrix.agent_id }})"

      - name: ç”Ÿæˆã•ã‚ŒãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
        run: |
          echo "=== ç”Ÿæˆã•ã‚ŒãŸãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ (${{ matrix.agent_id }}) ==="
          cat frontend_implementation_${{ matrix.agent_id }}.js

      - name: å®Ÿè£…ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã«é…ç½®
        run: |
          mkdir -p todo-app/frontend-${{ matrix.agent_id }}/src
          cp frontend_implementation_${{ matrix.agent_id }}.js todo-app/frontend-${{ matrix.agent_id }}/src/App.js
          cp todo-app/frontend/package.json todo-app/frontend-${{ matrix.agent_id }}/

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          cd todo-app/frontend-${{ matrix.agent_id }}
          npm install

      - name: åŸºæœ¬çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: |
          cd todo-app/frontend-${{ matrix.agent_id }}
          echo "æ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..." > test_result.txt
          if grep -q "import\|export\|function\|const" src/App.js; then
            echo "âœ… åŸºæœ¬çš„ãªæ§‹æ–‡è¦ç´ ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ" >> test_result.txt
          else
            echo "âŒ åŸºæœ¬çš„ãªæ§‹æ–‡è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> test_result.txt
          fi
          cat test_result.txt

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_id }}-results
          path: |
            todo-app/frontend-${{ matrix.agent_id }}/src/App.js
            todo-app/frontend-${{ matrix.agent_id }}/test_result.txt

  compare-results:
    needs: [backend-development, frontend-development]
    if: always()
    runs-on: ubuntu-latest
    name: çµæœæ¯”è¼ƒãƒ»çµ±åˆ
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4

      - name: é–‹ç™ºçµæœã‚’æ¯”è¼ƒãƒ»åˆ†æ
        run: |
          echo "=== Todo App é–‹ç™ºçµæœæ¯”è¼ƒ ===" > integration_report.txt
          echo "ç”Ÿæˆæ—¥æ™‚: $(date)" >> integration_report.txt
          echo "é–‹ç™ºå¯¾è±¡: ${{ github.event.inputs.development_target }}" >> integration_report.txt
          echo "ã‚¿ã‚¹ã‚¯: ${{ github.event.inputs.task_description }}" >> integration_report.txt
          echo "" >> integration_report.txt

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµæœåˆ†æ
          if [ "${{ github.event.inputs.development_target }}" = "backend" ] || [ "${{ github.event.inputs.development_target }}" = "both" ]; then
            echo "## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºçµæœ" >> integration_report.txt
            echo "" >> integration_report.txt
            
            for agent in backend-agent-a backend-agent-b; do
              echo "### $agent" >> integration_report.txt
              if [ -f "${agent}-results/test_result.txt" ]; then
                echo "ãƒ†ã‚¹ãƒˆçµæœ:" >> integration_report.txt
                cat "${agent}-results/test_result.txt" >> integration_report.txt
              fi
              echo "" >> integration_report.txt
            done
          fi

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµæœåˆ†æ
          if [ "${{ github.event.inputs.development_target }}" = "frontend" ] || [ "${{ github.event.inputs.development_target }}" = "both" ]; then
            echo "## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºçµæœ" >> integration_report.txt
            echo "" >> integration_report.txt
            
            for agent in frontend-agent-a frontend-agent-b; do
              echo "### $agent" >> integration_report.txt
              if [ -f "${agent}-results/test_result.txt" ]; then
                echo "ãƒ†ã‚¹ãƒˆçµæœ:" >> integration_report.txt
                cat "${agent}-results/test_result.txt" >> integration_report.txt
              fi
              echo "" >> integration_report.txt
            done
          fi

      - name: æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
        run: cat integration_report.txt

      - name: çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: integration-report
          path: integration_report.txt

name: Claude Dual Agent Implementation

on:
  push:
  workflow_dispatch:
    inputs:
      task_prompt:
        description: 'Claude ã«å®Ÿè¡Œã•ã›ã‚‹ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
        required: true
        default: 'FizzBuzzã‚’Pythoné–¢æ•° fizzbuzz(n: int) -> str ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ä»•æ§˜ï¼š3ã®å€æ•°ã¯Fizzã€5ã®å€æ•°ã¯Buzzã€15ã®å€æ•°ã¯FizzBuzzã€ãã‚Œä»¥å¤–ã¯æ•°å­—ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚'
      programming_language:
        description: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª'
        required: true
        default: 'python'
        type: choice
        options:
          - python
          - javascript
          - go
          - java
      file_extension:
        description: 'ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­'
        required: true
        default: 'py'
      test_command:
        description: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰'
        required: false
        default: 'python -m pytest'

jobs:
  generate-code:
    strategy:
      matrix:
        agent_id: [agent-a, agent-b]
    runs-on: ubuntu-latest
    name: Generate by ${{ matrix.agent_id }}
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Claude CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: Claude ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        run: claude --version

      - name: Claude ã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã•ã›ã‚‹ï¼ˆ${{ matrix.agent_id }}ï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "â–¶ Claude ã«å•ã„åˆã‚ã›ã¾ã™ï¼ˆAgent: ${{ matrix.agent_id }})"
          PROMPT="${{ github.event.inputs.task_prompt || 'FizzBuzzã‚’Pythoné–¢æ•° fizzbuzz(n: int) -> str ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ä»•æ§˜ï¼š3ã®å€æ•°ã¯Fizzã€5ã®å€æ•°ã¯Buzzã€15ã®å€æ•°ã¯FizzBuzzã€ãã‚Œä»¥å¤–ã¯æ•°å­—ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚' }}"
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          claude -p "$PROMPT" \
          > output_${{ matrix.agent_id }}.$FILE_EXT \
          || echo "Claude å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"

      - name: Claude å‡ºåŠ›ç¢ºèª
        run: |
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          cat output_${{ matrix.agent_id }}.$FILE_EXT

      - name: Claude å‡ºåŠ›ã‚’ä¿å­˜
        run: |
          mkdir -p modules/${{ matrix.agent_id }}
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          cat output_${{ matrix.agent_id }}.$FILE_EXT > modules/${{ matrix.agent_id }}/implementation.$FILE_EXT

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: pytest ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install pytest

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          TEST_CMD="${{ github.event.inputs.test_command || 'python -m pytest' }}"
          
          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          if [ -d "tests" ]; then
            cp -r tests/* modules/${{ matrix.agent_id }}/
          fi
          
          cd modules/${{ matrix.agent_id }}
          
          # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€çµæœã‚’ä¿å­˜
          if [ "$FILE_EXT" = "py" ]; then
            $TEST_CMD -v > test_result.txt 2>&1 || echo "ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          else
            echo "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª $FILE_EXT ã®ãƒ†ã‚¹ãƒˆã¯æœªå®Ÿè£…ã§ã™" > test_result.txt
          fi

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèª
        run: cat modules/${{ matrix.agent_id }}/test_result.txt

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_id }}-results
          path: |
            modules/${{ matrix.agent_id }}/implementation.*
            modules/${{ matrix.agent_id }}/test_result.txt

  compare-results:
    needs: generate-code
    runs-on: ubuntu-latest
    name: çµæœæ¯”è¼ƒãƒ»è©•ä¾¡
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4

      - name: çµæœã‚’æ¯”è¼ƒ
        run: |
          echo "=== ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµæœæ¯”è¼ƒ ===" > comparison_report.txt
          echo "ç”Ÿæˆæ—¥æ™‚: $(date)" >> comparison_report.txt
          echo "" >> comparison_report.txt
          
          # ãƒ†ã‚¹ãƒˆæˆåŠŸã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç‰¹å®š
          SUCCESSFUL_AGENTS=""
          for agent in agent-a agent-b; do
            echo "--- $agent ã®çµæœ ---" >> comparison_report.txt
            if [ -f "${agent}-results/test_result.txt" ]; then
              echo "ãƒ†ã‚¹ãƒˆçµæœ:" >> comparison_report.txt
              cat "${agent}-results/test_result.txt" >> comparison_report.txt
              
              # ãƒ†ã‚¹ãƒˆæˆåŠŸåˆ¤å®š
              if grep -q "PASSED" "${agent}-results/test_result.txt" && ! grep -q "FAILED" "${agent}-results/test_result.txt"; then
                SUCCESSFUL_AGENTS="$SUCCESSFUL_AGENTS $agent"
                echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ" >> comparison_report.txt
              else
                echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—" >> comparison_report.txt
              fi
            else
              echo "ãƒ†ã‚¹ãƒˆçµæœ: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> comparison_report.txt
            fi
            echo "" >> comparison_report.txt
            
            echo "å®Ÿè£…ã‚³ãƒ¼ãƒ‰:" >> comparison_report.txt
            if [ -f "${agent}-results/implementation.py" ]; then
              head -20 "${agent}-results/implementation.py" >> comparison_report.txt
            elif [ -f "${agent}-results/implementation.js" ]; then
              head -20 "${agent}-results/implementation.js" >> comparison_report.txt
            else
              echo "å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> comparison_report.txt
            fi
            echo "" >> comparison_report.txt
          done
          
          # æˆåŠŸã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "SUCCESSFUL_AGENTS=$SUCCESSFUL_AGENTS" >> $GITHUB_ENV

      - name: æ¯”è¼ƒçµæœã‚’è¡¨ç¤º
        run: cat comparison_report.txt

      - name: æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison_report.txt

  create-pr:
    needs: compare-results
    runs-on: ubuntu-latest
    name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
    if: success()
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4

      - name: æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        run: |
          BRANCH_NAME="claude-implementation-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: æˆåŠŸã—ãŸå®Ÿè£…ã‚’é¸æŠã—ã¦ã‚³ãƒŸãƒƒãƒˆ
        run: |
          # æœ€ã‚‚å„ªå…ˆåº¦ã®é«˜ã„æˆåŠŸå®Ÿè£…ã‚’é¸æŠï¼ˆagent-aã‚’å„ªå…ˆï¼‰
          SELECTED_AGENT=""
          for agent in agent-a agent-b; do
            if [ -f "${agent}-results/test_result.txt" ]; then
              if grep -q "PASSED" "${agent}-results/test_result.txt" && ! grep -q "FAILED" "${agent}-results/test_result.txt"; then
                SELECTED_AGENT=$agent
                break
              fi
            fi
          done
          
          if [ -n "$SELECTED_AGENT" ]; then
            echo "é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: $SELECTED_AGENT"
            
            # å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            if [ -f "${SELECTED_AGENT}-results/implementation.py" ]; then
              cp "${SELECTED_AGENT}-results/implementation.py" ./claude_generated_implementation.py
            elif [ -f "${SELECTED_AGENT}-results/implementation.js" ]; then
              cp "${SELECTED_AGENT}-results/implementation.js" ./claude_generated_implementation.js
            fi
            
            # æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚‚ã‚³ãƒ”ãƒ¼
            cp comparison-report/comparison_report.txt ./claude_analysis_report.txt
            
            echo "SELECTED_AGENT=$SELECTED_AGENT" >> $GITHUB_ENV
          else
            echo "ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ãŸå®Ÿè£…ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: Gitè¨­å®š
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Claude Auto-Implementation"

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git add claude_generated_implementation.* claude_analysis_report.txt
          git commit -m "Add Claude-generated implementation

          Task: ${{ github.event.inputs.task_prompt || 'FizzBuzz implementation' }}
          Language: ${{ github.event.inputs.programming_language || 'python' }}
          Selected Agent: $SELECTED_AGENT
          
          ğŸ¤– Generated with Claude Code via GitHub Actions
          
          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: git push origin $BRANCH_NAME

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_SUMMARY="${{ github.event.inputs.task_prompt || 'FizzBuzz implementation' }}"
          LANGUAGE="${{ github.event.inputs.programming_language || 'python' }}"
          
          gh pr create --title "ğŸ¤– Claudeå®Ÿè£…: $TASK_SUMMARY" --body "$(cat <<'EOF'
          ## ğŸ“‹ å®Ÿè£…æ¦‚è¦
          
          **ã‚¿ã‚¹ã‚¯**: $TASK_SUMMARY
          **è¨€èª**: $LANGUAGE
          **é¸æŠã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: $SELECTED_AGENT
          
          ## ğŸ” ç”Ÿæˆã•ã‚ŒãŸå®Ÿè£…
          
          Claude ãŒä¸¦åˆ—å®Ÿè¡Œã§ç”Ÿæˆã—ãŸå®Ÿè£…ã®ã†ã¡ã€ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ãŸå®Ÿè£…ã‚’é¸æŠã—ã¾ã—ãŸã€‚
          
          ## ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
          
          è©³ç´°ãªæ¯”è¼ƒåˆ†æã¯ `claude_analysis_report.txt` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          
          ## âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
          
          - [ ] å®Ÿè£…ãŒã‚¿ã‚¹ã‚¯è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ç¢ºèª
          - [ ] ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒ»å¯èª­æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒãªã„ã‹ç¢ºèª
          - [ ] æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®æ•´åˆæ€§ã‚’ç¢ºèª
          - [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å¦¥å½“æ€§ã‚’ç¢ºèª
          
          ## ğŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
          
          1. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½
          2. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
          3. è¿½åŠ ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
          4. ãƒãƒ¼ã‚¸åˆ¤æ–­
          
          ---
          
          ğŸ¤– **è‡ªå‹•ç”Ÿæˆ**: ã“ã®PRã¯GitHub Actions + Claude Code ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          
          **Co-Authored-By**: Claude <noreply@anthropic.com>
          EOF
          )"

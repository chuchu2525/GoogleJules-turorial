name: Claude Dual Agent Implementation

on:
  push:
  workflow_dispatch:
    inputs:
      task_prompt:
        description: "Claude ã«å®Ÿè¡Œã•ã›ã‚‹ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
        required: true
        default: "FizzBuzzã‚’Pythoné–¢æ•° fizzbuzz(n: int) -> str ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ä»•æ§˜ï¼š3ã®å€æ•°ã¯Fizzã€5ã®å€æ•°ã¯Buzzã€15ã®å€æ•°ã¯FizzBuzzã€ãã‚Œä»¥å¤–ã¯æ•°å­—ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚"
      programming_language:
        description: "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª"
        required: true
        default: "python"
        type: choice
        options:
          - python
          - javascript
          - go
          - java
      file_extension:
        description: "ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­"
        required: true
        default: "py"
      test_command:
        description: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰"
        required: false
        default: "python -m pytest"

jobs:
  generate-code:
    strategy:
      matrix:
        agent_id: [agent-a, agent-b]
    runs-on: ubuntu-latest
    name: Generate by ${{ matrix.agent_id }}
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Claude CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: Claude ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        run: claude --version

      - name: Claude ã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã•ã›ã‚‹ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "â–¶ Claude ã«å•ã„åˆã‚ã›ã¾ã™ï¼ˆAgent: ${{ matrix.agent_id }})"

          # åŸºæœ¬ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          BASE_PROMPT="${{ github.event.inputs.task_prompt || 'FizzBuzzã‚’Pythoné–¢æ•° fizzbuzz(n: int) -> str ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ä»•æ§˜ï¼š3ã®å€æ•°ã¯Fizzã€5ã®å€æ•°ã¯Buzzã€15ã®å€æ•°ã¯FizzBuzzã€ãã‚Œä»¥å¤–ã¯æ•°å­—ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚' }}"
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          LANG="${{ github.event.inputs.programming_language || 'python' }}"

          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
          if [ -f "tests/test_fizzbuzz.py" ]; then
            TEST_CONTENT=$(cat tests/test_fizzbuzz.py)
          else
            TEST_CONTENT="åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æƒ³å®šã—ã¦ãã ã•ã„"
          fi

          # ãƒªãƒˆãƒ©ã‚¤è¨­å®š
          MAX_RETRIES=5
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
            echo "=== å®Ÿè£…è©¦è¡Œ $((RETRY_COUNT + 1))/$MAX_RETRIES ==="
            
            if [ $RETRY_COUNT -eq 0 ]; then
              # åˆå›ï¼šTDDæŒ‡å‘ã®è©³ç´°ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
              ENHANCED_PROMPT="$BASE_PROMPT

              é‡è¦: ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’100%é€šéã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

              ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:
              $TEST_CONTENT

              è¦ä»¶:
              1. ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’é€šéã™ã‚‹ã“ã¨
              2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å«ã‚€ã“ã¨  
              3. å‹ãƒ’ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
              4. docstringã‚’å«ã‚€ã“ã¨
              5. ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ï¼ˆ0ãªã©ï¼‰ã‚‚è€ƒæ…®ã™ã‚‹ã“ã¨

              ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª: $LANG

              å‡ºåŠ›å½¢å¼ã®é‡è¦ãªæŒ‡ç¤º:
              - èª¬æ˜æ–‡ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸€åˆ‡å«ã‚ãªã„
              - Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ\`\`\`ï¼‰ã¯ä½¿ç”¨ã—ãªã„
              - ç´”ç²‹ãª$LANG ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’å‡ºåŠ›
              - ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã‹ã‚‰æœ«å°¾ã¾ã§å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒ¼ãƒ‰ã®ã¿

              å‡ºåŠ›: å®Œå…¨ãªå®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚„ã‚³ãƒ¡ãƒ³ãƒˆã‚‚å«ã‚€ï¼‰"
            else
              # ãƒªãƒˆãƒ©ã‚¤æ™‚ï¼šå‰å›ã®ã‚¨ãƒ©ãƒ¼ã‚’å«ã‚ã¦æ”¹å–„ã‚’ä¿ƒã™
              ENHANCED_PROMPT="å‰å›ã®å®Ÿè£…ã§ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

              ã‚¨ãƒ©ãƒ¼å†…å®¹:
              $(cat test_result_${{ matrix.agent_id }}.txt 2>/dev/null || echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼")

              å…ƒã®ã‚¿ã‚¹ã‚¯: $BASE_PROMPT

              ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:
              $TEST_CONTENT

              ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã‚’æ”¹å–„ã—ã¦ãã ã•ã„ï¼š
              - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¦ä»¶ã‚’æ­£ç¢ºã«æº€ãŸã™
              - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®å‡¦ç†ï¼ˆ0ã€è² ã®æ•°ãªã©ï¼‰
              - å‹ã®æ•´åˆæ€§
              - é–¢æ•°åã¨ã‚·ã‚°ãƒãƒãƒ£ã®æ­£ç¢ºæ€§
              - ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ã®è§£æ±º

              ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª: $LANG
              å‡ºåŠ›: ä¿®æ­£ã•ã‚ŒãŸå®Œå…¨ãªå®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«"
            fi
            
            # Claudeå®Ÿè¡Œ
            echo "Claudeå®Ÿè¡Œä¸­..."
            claude -p "$ENHANCED_PROMPT" > raw_output_${{ matrix.agent_id }}.$FILE_EXT || {
              echo "âŒ Claudeå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              continue
            }
            
            echo "Claudeç”Ÿå‡ºåŠ›ã‚’ç¢ºèª:"
            head -20 raw_output_${{ matrix.agent_id }}.$FILE_EXT
            echo "..."
            
            # Markdownã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ãƒ”ãƒ¥ã‚¢ãªã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            echo "ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºä¸­..."
            if [ "$FILE_EXT" = "py" ]; then
              if grep -q '```python' raw_output_${{ matrix.agent_id }}.$FILE_EXT; then
                sed -n '/```python/,/```/p' raw_output_${{ matrix.agent_id }}.$FILE_EXT | sed '1d;$d' > output_${{ matrix.agent_id }}.$FILE_EXT
              else
                cp raw_output_${{ matrix.agent_id }}.$FILE_EXT output_${{ matrix.agent_id }}.$FILE_EXT
              fi
            else
              # ä»–ã®è¨€èªã®å ´åˆ
              if grep -q '```' raw_output_${{ matrix.agent_id }}.$FILE_EXT; then
                sed -n '/```/,/```/p' raw_output_${{ matrix.agent_id }}.$FILE_EXT | sed '1d;$d' > output_${{ matrix.agent_id }}.$FILE_EXT
              else
                cp raw_output_${{ matrix.agent_id }}.$FILE_EXT output_${{ matrix.agent_id }}.$FILE_EXT
              fi
            fi
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            FILE_SIZE=$(wc -c < output_${{ matrix.agent_id }}.$FILE_EXT)
            echo "æŠ½å‡ºã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes"
            
            if [ $FILE_SIZE -lt 50 ]; then
              echo "âŒ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒå°ã•ã™ãã¾ã™"
              echo "ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹:"
              cat output_${{ matrix.agent_id }}.$FILE_EXT
              RETRY_COUNT=$((RETRY_COUNT + 1))
              continue
            fi
            
            echo "æŠ½å‡ºã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰:"
            cat output_${{ matrix.agent_id }}.$FILE_EXT
            
            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®æº–å‚™
            echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã®æº–å‚™ä¸­..."
            
            # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªå ´æ‰€ã«ã‚³ãƒ”ãƒ¼
            cp output_${{ matrix.agent_id }}.$FILE_EXT output_${{ matrix.agent_id }}.py 2>/dev/null || true
            
            # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
            echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹:"
            ls -la output_* 2>/dev/null || echo "output_* ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ç¢ºèª:"
            head -10 output_${{ matrix.agent_id }}.py
            
            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            echo "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
            if [ "$FILE_EXT" = "py" ]; then
              # Pythonã®å ´åˆ - æ”¹å–„ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
              echo "=== è©³ç´°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ===" > test_result_${{ matrix.agent_id }}.txt
              echo "å®Ÿè¡Œæ™‚åˆ»: $(date)" >> test_result_${{ matrix.agent_id }}.txt
              echo "" >> test_result_${{ matrix.agent_id }}.txt
              
              # åŸºæœ¬çš„ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆï¼ˆç°¡æ½”ç‰ˆï¼‰
              echo "=== ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ ===" >> test_result_${{ matrix.agent_id }}.txt
              
              # å˜ç´”ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
              python -c "import sys; sys.path.insert(0, '.'); import output_${{ matrix.agent_id }}; print('ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ'); print('fizzbuzz(15):', output_${{ matrix.agent_id }}.fizzbuzz(15))" >> test_result_${{ matrix.agent_id }}.txt 2>&1 || echo "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼" >> test_result_${{ matrix.agent_id }}.txt
              
              echo "" >> test_result_${{ matrix.agent_id }}.txt
              echo "=== pytestå®Ÿè¡Œ ===" >> test_result_${{ matrix.agent_id }}.txt
              
              # pytestå®Ÿè¡Œï¼ˆç’°å¢ƒå¤‰æ•°ã§Pythonãƒ‘ã‚¹ã‚’è¨­å®šï¼‰
              PYTHONPATH=. python -m pytest tests/test_fizzbuzz.py -v --tb=short --no-header >> test_result_${{ matrix.agent_id }}.txt 2>&1
              TEST_EXIT_CODE=$?
              
              echo "" >> test_result_${{ matrix.agent_id }}.txt
              echo "=== ãƒ†ã‚¹ãƒˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $TEST_EXIT_CODE ===" >> test_result_${{ matrix.agent_id }}.txt
              
            else
              echo "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª $FILE_EXT ã®ãƒ†ã‚¹ãƒˆã¯æœªå®Ÿè£…ã§ã™" > test_result_${{ matrix.agent_id }}.txt
              TEST_EXIT_CODE=1
            fi
            
            echo "ãƒ†ã‚¹ãƒˆçµæœ:"
            cat test_result_${{ matrix.agent_id }}.txt
            
            # ãƒ†ã‚¹ãƒˆæˆåŠŸåˆ¤å®šï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªåˆ¤å®šï¼‰
            SUCCESS_PATTERNS=("PASSED" "passed" "OK" "âœ“" "All tests passed" "test session starts")
            FAILURE_PATTERNS=("FAILED" "failed" "ERROR" "error" "FAIL" "ImportError" "ModuleNotFoundError")
            
            TEST_SUCCESS=false
            
            # æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            for pattern in "${SUCCESS_PATTERNS[@]}"; do
              if grep -q "$pattern" test_result_${{ matrix.agent_id }}.txt; then
                TEST_SUCCESS=true
                break
              fi
            done
            
            # å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæˆåŠŸåˆ¤å®šã‚’ä¸Šæ›¸ãï¼‰
            for pattern in "${FAILURE_PATTERNS[@]}"; do
              if grep -q "$pattern" test_result_${{ matrix.agent_id }}.txt; then
                TEST_SUCCESS=false
                break
              fi
            done
            
            # è¿½åŠ ã®æˆåŠŸåˆ¤å®šï¼šãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒæ­£å¸¸çµ‚äº†ã—ã€å¤±æ•—ãŒãªã„å ´åˆ
            if [ $TEST_EXIT_CODE -eq 0 ] && ! grep -q "FAILED\|failed\|ERROR\|error" test_result_${{ matrix.agent_id }}.txt; then
              TEST_SUCCESS=true
            fi
            
            if [ "$TEST_SUCCESS" = true ]; then
              echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸï¼å®Ÿè£…ã‚’æ¡ç”¨ã—ã¾ã™"
              SUCCESS=true
              
              # æˆåŠŸã—ãŸå®Ÿè£…ã‚’æœ€çµ‚ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
              cp output_${{ matrix.agent_id }}.$FILE_EXT final_implementation_${{ matrix.agent_id }}.$FILE_EXT
              
              # æˆåŠŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²
              echo "SUCCESS_RETRY_COUNT=$RETRY_COUNT" >> $GITHUB_ENV
              echo "FINAL_TEST_RESULT=PASSED" >> $GITHUB_ENV
              
            else
              echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—ã€‚ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™..."
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
              echo "ãƒ‡ãƒãƒƒã‚°æƒ…å ±:"
              echo "- ãƒ†ã‚¹ãƒˆçµ‚äº†ã‚³ãƒ¼ãƒ‰: $TEST_EXIT_CODE"
              echo "- ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -l < output_${{ matrix.agent_id }}.$FILE_EXT) è¡Œ"
              echo "- ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -l < test_result_${{ matrix.agent_id }}.txt) è¡Œ"
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "âŒ $MAX_RETRIES å›ã®è©¦è¡Œå¾Œã‚‚ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã›ã‚“ã§ã—ãŸ"
            echo "æœ€å¾Œã®ã‚¨ãƒ©ãƒ¼:"
            cat test_result_${{ matrix.agent_id }}.txt
            
            # å¤±æ•—ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¨˜éŒ²
            echo "SUCCESS_RETRY_COUNT=$MAX_RETRIES" >> $GITHUB_ENV
            echo "FINAL_TEST_RESULT=FAILED" >> $GITHUB_ENV
            
            # å¤±æ•—æ™‚ã‚‚å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            cp output_${{ matrix.agent_id }}.$FILE_EXT final_implementation_${{ matrix.agent_id }}.$FILE_EXT
          fi

      - name: Claude å‡ºåŠ›ç¢ºèª
        run: |
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          cat output_${{ matrix.agent_id }}.$FILE_EXT

      - name: Claude å‡ºåŠ›ã‚’ä¿å­˜
        run: |
          mkdir -p modules/${{ matrix.agent_id }}
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          cat output_${{ matrix.agent_id }}.$FILE_EXT > modules/${{ matrix.agent_id }}/implementation.$FILE_EXT

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: pytest ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install pytest

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          TEST_CMD="${{ github.event.inputs.test_command || 'python -m pytest' }}"

          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          if [ -d "tests" ]; then
            cp -r tests/* modules/${{ matrix.agent_id }}/
          fi

          cd modules/${{ matrix.agent_id }}

          # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€çµæœã‚’ä¿å­˜
          if [ "$FILE_EXT" = "py" ]; then
            $TEST_CMD -v > test_result.txt 2>&1 || echo "ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          else
            echo "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª $FILE_EXT ã®ãƒ†ã‚¹ãƒˆã¯æœªå®Ÿè£…ã§ã™" > test_result.txt
          fi

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèª
        run: cat modules/${{ matrix.agent_id }}/test_result.txt

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_id }}-results
          path: |
            modules/${{ matrix.agent_id }}/implementation.*
            modules/${{ matrix.agent_id }}/test_result.txt

  compare-results:
    needs: generate-code
    runs-on: ubuntu-latest
    name: çµæœæ¯”è¼ƒãƒ»è©•ä¾¡
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4

      - name: çµæœã‚’æ¯”è¼ƒ
        run: |
          echo "=== ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçµæœæ¯”è¼ƒ ===" > comparison_report.txt
          echo "ç”Ÿæˆæ—¥æ™‚: $(date)" >> comparison_report.txt
          echo "" >> comparison_report.txt

          # ãƒ†ã‚¹ãƒˆæˆåŠŸã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç‰¹å®š
          SUCCESSFUL_AGENTS=""
          for agent in agent-a agent-b; do
            echo "--- $agent ã®çµæœ ---" >> comparison_report.txt
            if [ -f "${agent}-results/test_result.txt" ]; then
              echo "ãƒ†ã‚¹ãƒˆçµæœ:" >> comparison_report.txt
              cat "${agent}-results/test_result.txt" >> comparison_report.txt
              
              # ãƒ†ã‚¹ãƒˆæˆåŠŸåˆ¤å®š
              if grep -q "PASSED" "${agent}-results/test_result.txt" && ! grep -q "FAILED" "${agent}-results/test_result.txt"; then
                SUCCESSFUL_AGENTS="$SUCCESSFUL_AGENTS $agent"
                echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ" >> comparison_report.txt
              else
                echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—" >> comparison_report.txt
              fi
            else
              echo "ãƒ†ã‚¹ãƒˆçµæœ: ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> comparison_report.txt
            fi
            echo "" >> comparison_report.txt
            
            echo "å®Ÿè£…ã‚³ãƒ¼ãƒ‰:" >> comparison_report.txt
            if [ -f "${agent}-results/implementation.py" ]; then
              head -20 "${agent}-results/implementation.py" >> comparison_report.txt
            elif [ -f "${agent}-results/implementation.js" ]; then
              head -20 "${agent}-results/implementation.js" >> comparison_report.txt
            else
              echo "å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> comparison_report.txt
            fi
            echo "" >> comparison_report.txt
          done

          # æˆåŠŸã—ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "SUCCESSFUL_AGENTS=$SUCCESSFUL_AGENTS" >> $GITHUB_ENV

      - name: æ¯”è¼ƒçµæœã‚’è¡¨ç¤º
        run: cat comparison_report.txt

      - name: æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison_report.txt

  create-pr:
    needs: compare-results
    runs-on: ubuntu-latest
    name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
    if: success()
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4

      - name: æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        run: |
          BRANCH_NAME="claude-implementation-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: æˆåŠŸã—ãŸå®Ÿè£…ã‚’é¸æŠã—ã¦ã‚³ãƒŸãƒƒãƒˆ
        run: |
          # æœ€ã‚‚å„ªå…ˆåº¦ã®é«˜ã„æˆåŠŸå®Ÿè£…ã‚’é¸æŠï¼ˆagent-aã‚’å„ªå…ˆï¼‰
          SELECTED_AGENT=""
          for agent in agent-a agent-b; do
            if [ -f "${agent}-results/test_result.txt" ]; then
              if grep -q "PASSED" "${agent}-results/test_result.txt" && ! grep -q "FAILED" "${agent}-results/test_result.txt"; then
                SELECTED_AGENT=$agent
                break
              fi
            fi
          done

          if [ -n "$SELECTED_AGENT" ]; then
            echo "é¸æŠã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: $SELECTED_AGENT"
            
            # å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            if [ -f "${SELECTED_AGENT}-results/implementation.py" ]; then
              cp "${SELECTED_AGENT}-results/implementation.py" ./claude_generated_implementation.py
            elif [ -f "${SELECTED_AGENT}-results/implementation.js" ]; then
              cp "${SELECTED_AGENT}-results/implementation.js" ./claude_generated_implementation.js
            fi
            
            # æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚‚ã‚³ãƒ”ãƒ¼
            cp comparison-report/comparison_report.txt ./claude_analysis_report.txt
            
            echo "SELECTED_AGENT=$SELECTED_AGENT" >> $GITHUB_ENV
          else
            echo "ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ãŸå®Ÿè£…ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      - name: Gitè¨­å®š
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Claude Auto-Implementation"

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git add claude_generated_implementation.* claude_analysis_report.txt
          git commit -m "Add Claude-generated implementation

          Task: ${{ github.event.inputs.task_prompt || 'FizzBuzz implementation' }}
          Language: ${{ github.event.inputs.programming_language || 'python' }}
          Selected Agent: $SELECTED_AGENT

          ğŸ¤– Generated with Claude Code via GitHub Actions

          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: git push origin $BRANCH_NAME

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_SUMMARY="${{ github.event.inputs.task_prompt || 'FizzBuzz implementation' }}"
          LANGUAGE="${{ github.event.inputs.programming_language || 'python' }}"

          gh pr create --title "ğŸ¤– Claudeå®Ÿè£…: $TASK_SUMMARY" --body "$(cat <<'EOF'
          ## ğŸ“‹ å®Ÿè£…æ¦‚è¦

          **ã‚¿ã‚¹ã‚¯**: $TASK_SUMMARY
          **è¨€èª**: $LANGUAGE
          **é¸æŠã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: $SELECTED_AGENT

          ## ğŸ” ç”Ÿæˆã•ã‚ŒãŸå®Ÿè£…

          Claude ãŒä¸¦åˆ—å®Ÿè¡Œã§ç”Ÿæˆã—ãŸå®Ÿè£…ã®ã†ã¡ã€ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ãŸå®Ÿè£…ã‚’é¸æŠã—ã¾ã—ãŸã€‚

          ## ğŸ“Š åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

          è©³ç´°ãªæ¯”è¼ƒåˆ†æã¯ `claude_analysis_report.txt` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

          ## âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ

          - [ ] å®Ÿè£…ãŒã‚¿ã‚¹ã‚¯è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ç¢ºèª
          - [ ] ã‚³ãƒ¼ãƒ‰ã®å“è³ªãƒ»å¯èª­æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒãªã„ã‹ç¢ºèª
          - [ ] æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®æ•´åˆæ€§ã‚’ç¢ºèª
          - [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å¦¥å½“æ€§ã‚’ç¢ºèª

          ## ğŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

          1. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½
          2. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
          3. è¿½åŠ ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
          4. ãƒãƒ¼ã‚¸åˆ¤æ–­

          ---

          ğŸ¤– **è‡ªå‹•ç”Ÿæˆ**: ã“ã®PRã¯GitHub Actions + Claude Code ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ

          **Co-Authored-By**: Claude <noreply@anthropic.com>
          EOF
          )"

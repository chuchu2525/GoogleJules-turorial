name: Claude Dual Agent Implementation

on:
  push:
  workflow_dispatch:
    inputs:
      task_prompt:
        description: "Claude ã«å®Ÿè¡Œã•ã›ã‚‹ã‚¿ã‚¹ã‚¯ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"
        required: true
        default: "FizzBuzzã‚’Pythoné–¢æ•° fizzbuzz(n: int) -> str ã§å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚ä»•æ§˜ï¼š3ã®å€æ•°ã¯Fizzã€5ã®å€æ•°ã¯Buzzã€15ã®å€æ•°ã¯FizzBuzzã€ãã‚Œä»¥å¤–ã¯æ•°å­—ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚"
      programming_language:
        description: "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª"
        required: true
        default: "python"
        type: choice
        options:
          - python
          - javascript
          - go
          - java
      file_extension:
        description: "ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­"
        required: true
        default: "py"
      test_command:
        description: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰"
        required: false
        default: "python -m pytest"

jobs:
  generate-code:
    strategy:
      matrix:
        agent_id: [agent-a, agent-b]
    runs-on: ubuntu-latest
    name: Generate by ${{ matrix.agent_id }}
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Claude CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: Claude ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
        run: claude --version

      - name: Kamuiå¼ Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œï¼ˆ${{ matrix.agent_id }}ï¼‰
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸ¤– Kamuiå¼ Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆèµ·å‹•ï¼ˆAgent: ${{ matrix.agent_id }})"

          # ãƒ†ã‚¹ãƒˆä»•æ§˜ã‚’èª­ã¿è¾¼ã‚“ã§è²¬å‹™ã‚’æ˜ç¢ºåŒ–
          if [ -f "tests/test_fizzbuzz.py" ]; then
            TEST_SPEC=$(cat tests/test_fizzbuzz.py)
            echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆä»•æ§˜ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ"
          else
            TEST_SPEC="åŸºæœ¬çš„ãªFizzBuzzãƒ†ã‚¹ãƒˆã‚’æƒ³å®š"
          fi

          # Kamuiå¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šè²¬å‹™ã¨è‡ªç”±åº¦ã‚’æ˜ç¢ºã«å®šç¾©
          KAMUI_PROMPT="ã‚ãªãŸã¯è‡ªå¾‹çš„ãªå®Ÿè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆ${{ matrix.agent_id }}ï¼‰ã§ã™ã€‚

          ã€è²¬å‹™ã€‘ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’100%é€šéã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
          $TEST_SPEC

          ã€è‡ªç”±åº¦ã€‘å®Ÿè£…æ–¹æ³•ã¯è‡ªç”±ã§ã™ã€‚å‰µé€ æ€§ã‚’ç™ºæ®ã—ã¦ãã ã•ã„ï¼š
          - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é¸æŠ
          - ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
          - æœ€é©åŒ–æ‰‹æ³•
          - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

          ã€å‡ºåŠ›è¦æ±‚ã€‘
          - Pythoné–¢æ•° fizzbuzz(n: int) -> str ã‚’å®Ÿè£…
          - ãƒ†ã‚¹ãƒˆãŒé€šã‚‹å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã®ã¿å‡ºåŠ›
          - èª¬æ˜æ–‡ã¯ä¸è¦

          ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‰¹æ€§ã€‘
          Agent-A: å …å®Ÿã§èª­ã¿ã‚„ã™ã„å®Ÿè£…ã‚’é‡è¦–
          Agent-B: å‰µé€ çš„ã§åŠ¹ç‡çš„ãªå®Ÿè£…ã‚’é‡è¦–

          å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š"

          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"

          echo "ğŸ’­ Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ€è€ƒä¸­..."
          claude -p "$KAMUI_PROMPT" > output_${{ matrix.agent_id }}.$FILE_EXT || {
            echo "âŒ Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œå¤±æ•—"
            echo "# ã‚¨ãƒ©ãƒ¼: Claudeå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ" > output_${{ matrix.agent_id }}.$FILE_EXT
          }

          echo "âœ… Claude ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Œäº†ï¼ˆAgent: ${{ matrix.agent_id }}ï¼‰"

      - name: Claude å‡ºåŠ›ç¢ºèª
        run: |
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          cat output_${{ matrix.agent_id }}.$FILE_EXT

      - name: Claude å‡ºåŠ›ã‚’ä¿å­˜
        run: |
          mkdir -p modules/${{ matrix.agent_id }}
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          cat output_${{ matrix.agent_id }}.$FILE_EXT > modules/${{ matrix.agent_id }}/implementation.$FILE_EXT

      - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: pytest ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install pytest

      - name: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          FILE_EXT="${{ github.event.inputs.file_extension || 'py' }}"
          TEST_CMD="${{ github.event.inputs.test_command || 'python -m pytest' }}"

          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
          if [ -d "tests" ]; then
            cp -r tests/* modules/${{ matrix.agent_id }}/
          fi

          cd modules/${{ matrix.agent_id }}

          # ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€çµæœã‚’ä¿å­˜
          if [ "$FILE_EXT" = "py" ]; then
            $TEST_CMD -v > test_result.txt 2>&1 || echo "ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
          else
            echo "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª $FILE_EXT ã®ãƒ†ã‚¹ãƒˆã¯æœªå®Ÿè£…ã§ã™" > test_result.txt
          fi

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèª
        run: cat modules/${{ matrix.agent_id }}/test_result.txt

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.agent_id }}-results
          path: |
            modules/${{ matrix.agent_id }}/implementation.*
            modules/${{ matrix.agent_id }}/test_result.txt

  kamui-evaluation:
    needs: generate-code
    runs-on: ubuntu-latest
    name: ğŸ† Kamuiå¼ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ãƒ»é¸å®š
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4

      - name: Kamuiå¼ è‡ªå¾‹è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ 
        run: |
          echo "ğŸ† === Kamuiå¼ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ  ===" > kamui_evaluation.txt
          echo "è©•ä¾¡æ—¥æ™‚: $(date)" >> kamui_evaluation.txt
          echo "è©•ä¾¡åŸºæº–: ãƒ†ã‚¹ãƒˆé€šéç‡ã€ã‚³ãƒ¼ãƒ‰å“è³ªã€å‰µé€ æ€§" >> kamui_evaluation.txt
          echo "" >> kamui_evaluation.txt

          # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
          BEST_AGENT=""
          BEST_SCORE=0

          for agent in agent-a agent-b; do
            echo "ğŸ¤– === ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè©•ä¾¡: $agent ===" >> kamui_evaluation.txt
            SCORE=0
            
            # 1. ãƒ†ã‚¹ãƒˆé€šéè©•ä¾¡ï¼ˆæœ€é‡è¦ï¼‰
            if [ -f "${agent}-results/test_result.txt" ]; then
              echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœ:" >> kamui_evaluation.txt
              cat "${agent}-results/test_result.txt" >> kamui_evaluation.txt
              
              if grep -q "PASSED\|passed" "${agent}-results/test_result.txt" && ! grep -q "FAILED\|failed" "${agent}-results/test_result.txt"; then
                SCORE=$((SCORE + 100))
                echo "âœ… ãƒ†ã‚¹ãƒˆé€šé: +100ç‚¹" >> kamui_evaluation.txt
              else
                echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: +0ç‚¹" >> kamui_evaluation.txt
              fi
            else
              echo "âš ï¸ ãƒ†ã‚¹ãƒˆçµæœãªã—: +0ç‚¹" >> kamui_evaluation.txt
            fi
            
            # 2. ã‚³ãƒ¼ãƒ‰å“è³ªè©•ä¾¡
            if [ -f "${agent}-results/implementation.py" ]; then
              CODE_LINES=$(wc -l < "${agent}-results/implementation.py")
              CODE_SIZE=$(wc -c < "${agent}-results/implementation.py")
              
              echo "ğŸ“ ã‚³ãƒ¼ãƒ‰è¡Œæ•°: ${CODE_LINES}è¡Œ" >> kamui_evaluation.txt
              echo "ğŸ“¦ ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚º: ${CODE_SIZE}ãƒã‚¤ãƒˆ" >> kamui_evaluation.txt
              
              # é©åˆ‡ãªã‚µã‚¤ã‚ºãƒœãƒ¼ãƒŠã‚¹ï¼ˆ50-200è¡ŒãŒç†æƒ³ï¼‰
              if [ $CODE_LINES -ge 10 ] && [ $CODE_LINES -le 50 ]; then
                SCORE=$((SCORE + 20))
                echo "âœ… é©åˆ‡ãªã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚º: +20ç‚¹" >> kamui_evaluation.txt
              fi
              
              # å‹ãƒ’ãƒ³ãƒˆãƒ»docstringè©•ä¾¡
              if grep -q "def fizzbuzz.*int.*str" "${agent}-results/implementation.py"; then
                SCORE=$((SCORE + 10))
                echo "âœ… å‹ãƒ’ãƒ³ãƒˆä½¿ç”¨: +10ç‚¹" >> kamui_evaluation.txt
              fi
              
              if grep -q '"""' "${agent}-results/implementation.py"; then
                SCORE=$((SCORE + 10))
                echo "âœ… docstringè¨˜è¿°: +10ç‚¹" >> kamui_evaluation.txt
              fi
              
              echo "ğŸ“„ å®Ÿè£…ã‚³ãƒ¼ãƒ‰ï¼ˆå…ˆé ­20è¡Œï¼‰:" >> kamui_evaluation.txt
              head -20 "${agent}-results/implementation.py" >> kamui_evaluation.txt
            else
              echo "âŒ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ãªã—: +0ç‚¹" >> kamui_evaluation.txt
            fi
            
            echo "ğŸ¯ ç·åˆã‚¹ã‚³ã‚¢: ${SCORE}ç‚¹" >> kamui_evaluation.txt
            echo "" >> kamui_evaluation.txt
            
            # ãƒ™ã‚¹ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¤å®š
            if [ $SCORE -gt $BEST_SCORE ]; then
              BEST_SCORE=$SCORE
              BEST_AGENT=$agent
            fi
          done

          # æœ€çµ‚åˆ¤å®š
          echo "ğŸ† === æœ€çµ‚åˆ¤å®š ===" >> kamui_evaluation.txt
          echo "ğŸ¥‡ ãƒ™ã‚¹ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: $BEST_AGENT" >> kamui_evaluation.txt
          echo "ğŸ¯ æœ€é«˜ã‚¹ã‚³ã‚¢: ${BEST_SCORE}ç‚¹" >> kamui_evaluation.txt
          echo "" >> kamui_evaluation.txt

          # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‰¹æ€§åˆ†æ
          echo "ğŸ” === ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‰¹æ€§åˆ†æ ===" >> kamui_evaluation.txt
          echo "Agent-Aï¼ˆå …å®Ÿå‹ï¼‰: èª­ã¿ã‚„ã™ã•ã¨å®‰å®šæ€§ã‚’é‡è¦–" >> kamui_evaluation.txt
          echo "Agent-Bï¼ˆå‰µé€ å‹ï¼‰: åŠ¹ç‡æ€§ã¨é©æ–°æ€§ã‚’é‡è¦–" >> kamui_evaluation.txt
          echo "" >> kamui_evaluation.txt

          # ç’°å¢ƒå¤‰æ•°ã«çµæœã‚’ä¿å­˜
          echo "KAMUI_BEST_AGENT=$BEST_AGENT" >> $GITHUB_ENV
          echo "KAMUI_BEST_SCORE=$BEST_SCORE" >> $GITHUB_ENV

      - name: Kamuiè©•ä¾¡çµæœã‚’è¡¨ç¤º
        run: |
          echo "ğŸ† Kamuiå¼è©•ä¾¡å®Œäº†ï¼"
          cat kamui_evaluation.txt

      - name: Kamuiè©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: kamui-evaluation-report
          path: kamui_evaluation.txt

      - name: ğŸ¯ Kamuiå¼ ãƒ™ã‚¹ãƒˆå®Ÿè£…ã®ä¿å­˜
        run: |
          if [ -n "$KAMUI_BEST_AGENT" ] && [ -f "${KAMUI_BEST_AGENT}-results/implementation.py" ]; then
            echo "ğŸ¥‡ ãƒ™ã‚¹ãƒˆå®Ÿè£…ã‚’ä¿å­˜ä¸­..."
            cp "${KAMUI_BEST_AGENT}-results/implementation.py" kamui_best_implementation.py
            
            echo "# Kamuiå¼ ãƒ™ã‚¹ãƒˆå®Ÿè£…" > kamui_summary.md
            echo "- **é¸å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**: $KAMUI_BEST_AGENT" >> kamui_summary.md
            echo "- **ã‚¹ã‚³ã‚¢**: ${KAMUI_BEST_SCORE}ç‚¹" >> kamui_summary.md
            echo "- **è©•ä¾¡æ—¥æ™‚**: $(date)" >> kamui_summary.md
            echo "" >> kamui_summary.md
            echo "\`\`\`python" >> kamui_summary.md
            cat kamui_best_implementation.py >> kamui_summary.md
            echo "\`\`\`" >> kamui_summary.md
            
            echo "âœ… Kamuiå¼ãƒ™ã‚¹ãƒˆå®Ÿè£…ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ æœ‰åŠ¹ãªå®Ÿè£…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Kamuiæœ€çµ‚æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: kamui-best-results
          path: |
            kamui_best_implementation.py
            kamui_summary.md
